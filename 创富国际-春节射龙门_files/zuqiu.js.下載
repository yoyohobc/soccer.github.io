//app调用ios
window.getInfoCallback = function (info) {
  $.getInfoIos(info);
};

var initGame = false;
// cf139 看來已被棄用 (?)
// var mis_url = 'https://mis.cf139.com';
// var mis_url = '//mis.cf860.com';

var mis_url = 'https://mis.cfd139.com';
// var mis_url = "http://mis.will68.com"

// 正式站
var actId = 20210211;
// 正式前測試
// var actId = 20210127;
// var actId = 20201228;
var appCustomerNo, userInfo, account;

// TODO: 測試帳號用打開
// {activetime: 1598335818000, amount: 100}
// var account = 81018235;
// {activetime: 0, amount: 0}
// var account = 81017548;
// []
// var account = 81016727;

// 激活
// {activetime: 1609728360000, amount: 100}
// var account = 81018453;
// 未激活
// {activetime: 0, amount: 0}
// var account = 81018455;
// 激活(黑名单)
// {activetime: 1609728360000, amount: 100}
// var account = 81018454;

// var account = 11111111;

// TODO: 測試帳號用打開
// var userInfo = { 'account': account,
//     'accountType': 1,
//     'channel': 'umeng',
//     'firstLogin': false,
//     'hasReal': true,
//     'appVerCode': 177
//   };

$.extend({
  closeMessage(message) {
    $("#popup-wrapper").show();
    $("#message-section").show();
    $("#message-section .description").html(message)
  },
  mechined() {
    var u = navigator.userAgent;
    var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; // android终端
    var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); // ios终端
    if (isAndroid) return 0;
    if (isiOS) return 1;
    else return -1;
  },
  getAppUserInfo() {
    var type = $.mechined(),
        user;

    //  如果是安卓手机浏览器且是配置的是APP内应用
    if (type == 0 && typeof (uiObject) !== "undefined") {
      useInfo = uiObject.getInfo(); //android终端
      alert(JSON.stringify(useInfo));
    } else if (type == 1) {
      if (typeof (window.getInfo) !== "undefined") {
        useInfo = window.getInfo()
      } else {
        window.webkit.messageHandlers.getInfo.postMessage("")
      }
    };
      // TODO: 正式帳號用打開
      userInfo = $.parseJSON(useInfo);
      appCustomerNo = userInfo.account;

      $.checkActivation(appCustomerNo)
  },
  //新版ios
  getInfoIos(info) {
    appCustomerNo = info.account;
    userInfo = info
  },
  ajaxData: function (options, callbackSuc, callbackErr) {
    options = $.extend(options, {
      "_r": Math.random()
    });
    $.ajax({
      type: options.ajaxtype,
      url: options.url,
      async: true,
      data: options,
      dataType: "json", //数据类型为jsonp
      success: function (data) {
        if ($.isFunction(callbackSuc)) callbackSuc(data);
      },
      error: function (data) {
        if ($.isFunction(callbackErr)) callbackErr(data);
      }
    });
  },
  jsonpAjax: function (options, callbackSuc, callbackErr) {
    $.extend(options, {
      _r: Math.random()
    });
    var jsonPUrl = options.url;
    $.ajax({
      type: "GET",
      url: jsonPUrl,
      async: true,
      data: options,
      dataType: "jsonp", // 数据类型为jsonp
      jsonp: 'jsonpCallback',
      success: function (data) {
        if ($.isFunction(callbackSuc)) callbackSuc(data);
      },
      error: function (data) {
        console.log("请求失败，url :" + options.url);
        if ($.isFunction(callbackErr)) callbackErr(data);
      }
    });

  },
  //get提交加载
  loadingGet: function (param, callbackSuc, callbackErr) {
    param = $.extend(param, {
      "ajaxtype": "GET"
    });
    $.jsonpAjax(param, callbackSuc, callbackErr);
  },
  //post提交加载
  loadingPost: function (param, callbackSuc, callbackErr) {
    param = $.extend(param, {
      "ajaxtype": "POST"
    });
    $.jsonpAjax(param, callbackSuc, callbackErr);
  },
  //post提交加载
  loadingPostNo: function (param, callbackSuc, callbackErr) {
    param = $.extend(param, {
      "ajaxtype": "POST"
    });
    $.ajaxData(param, callbackSuc, callbackErr);
  },
  loadingGetNo: function (param, callbackSuc, callbackErr) {
    param = $.extend(param, {
      "ajaxtype": "GET"
    });
    $.ajaxData(param, callbackSuc, callbackErr);
  },
  initEvent() {
    // 請到 app 玩遊戲, in WEB
    $("#btn-goplay").click(function() {
      $('#popup-wrapper').hide();
      $('#go-to-app-section').hide();
      // 判斷是否要連去app或下載apk
      $.downloadApp();
  })
  //返回
  //   $("#back").click(function () {
  //     $("#gameArea").hide();
  //     $.noScroll(false);
  //     location.reload();
  //   })
    //查看奖励
    $("#btn-award").click(function () {
      $('#popup-wrapper').show();
      $("#award-section").show();
    })
    //关闭弹窗
    $(".btn-close").click(function () {
      $('#popup-wrapper').hide();
      $('.popup-content').hide();
    })
    $(".btn-close-message").click(function () {
      if($('#game').css('display') === 'none'){
        $('#popup-wrapper').hide();
        $('.popup-content').hide();
      }else{
        $('#message-section').hide();
      }
    })

     // try {
     // console.log($.mechined());
       if ($.mechined() == 0) {//android
         $(".download a").attr("href", 'https://sc.tfejy.com/source/material/CFD_APP.apk')
       }else if ($.mechined() == 1){//ios
         $(".download a").attr("href","https://itunes.apple.com/us/app/chuang-fucfd/id1153506842?mt=8")
         $(".download").click(function(){
           window.open("https://itunes.apple.com/us/app/chuang-fucfd/id1153506842?mt=8");
         })
       }else{
         $(".download a").attr("href","https://sc.tfejy.com/source/material/CFD_APP.apk")
       }
     // } catch (e){
     //     console.log(e);
     //     $(".download a").attr("href","https://itunes.apple.com/us/app/chuang-fucfd/id1153506842?mt=8")
     // }

     // $(".download a").click(function (){
     //   try{

     //   }catch(e){
     //     console.log(e);
     //     console.log('catch');


     //   }
     // })
  },
  noScroll(noScroll){

   if(noScroll){
  //    startPage.addEventListener('touchmove',function(e){
  //      e.preventDefault();
  //    },{passive: false});
  //    gameArea.addEventListener('touchmove',function(e){
  //      e.preventDefault();
  //    },{passive: false});

    //  $("body").css("overflow","hidden");
    //  $("body").css("position","fixed");
    //  $("body").css("z-index","100");

   }else{
     // document.removeEventListener('touchmove',function(e){
     //   e.preventDefault();
     // },{passive: false})
     $("body").css("overflow","unset");
     $("body").css("position","unset");
   }
 },
 downloadApp() {

      // android
      if ($.mechined() == 0) {
          window.location.href = 'https://sc.tfejy.com/source/material/CFD_APP.apk';
      // ios
      }else if ($.mechined() == 1){
          window.location.href = 'https://apps.apple.com/cn/app/%E5%88%9B%E5%AF%8Ccfd-%E5%A4%96%E6%B1%87%E5%8E%9F%E6%B2%B9%E4%BA%A4%E6%98%93%E6%9C%9F%E8%B4%A7%E8%B4%B5%E9%87%91%E5%B1%9E%E6%8A%95%E8%B5%84%E5%B9%B3%E5%8F%B0/id1153506842'
      }else{
          window.location.href = 'https://sc.tfejy.com/source/material/CFD_APP.apk';
      }
  },
  // 判斷帳戶是否激活
  checkActivation: function (appCustomerNo) {
    var options = {
        "url": mis_url + "/public/customer/act/" + appCustomerNo
    };
    $.jsonpAjax(options, function (res) {

      if (res.code == 200) {
          data = res.ch_msg;
          if (data[0]!== '' && data.length > 0) {
              //Array(1)
              // if (data[0].activetime == "undefined" || data[0].activetime === "") {
              // 登录未激活，跳转存款页面
              if(data[0].activetime === 0 ){
                $('#popup-wrapper').show();
                $("#notice-section").show();
                $('#notice-section a').attr("href", 'https://admin.cfdealer88.com/?intercept_deposit');
              }
          } else {
            // 未登录未激活
            // res.ch_msg = [], Array(0)
            // $.closeMessage(res.ch_msg + '此帐号无效')
          }
      }
  })
},
  // activation: function(){
  //   var options = {
  //     // /tracker/queryByPage
  //     // /api/activity/luckyDrawReCord/activation/
  //     "url": mis_url + "/api/activity/luckyDrawReCord/activation/",
  //     "account": account,
  //     "luckyDrawId": actId,
  //     "type": 1
  //   };
  //   $.loadingGetNo(options, function(res) {
  //       if (res.code == 0) {
  //           data = res.data;
  //           if (data.activationStatus == 1) {
  //               $.rotateFn();
  //           } else if (data.activationStatus == 2) {
  //             $('#popup-wrapper').show();
  //             $("#notice-section").show();

  //           } else {
  //             $('#popup-wrapper').show();
  //             $("#notice-section").show();

  //           }
  //       } else {
  //           alert(res.msg)
  //       }
  //   }, function(err) {

  //     $('#popup-wrapper').show();
  //     $("#notice-section").show();
  //     console.log('激活 err:'+ err);
  //   })
  // },
  //开始游戏
  startGame: function () {

    $('#game').show()
    $('#popup-wrapper').show();

    createjs.Sound.play("soundtrack", {
      loop: -1
    });

    if(!initGame){
        initGame = true
        var oMain = new CMain({
            shot_indicator_spd: 1000,
            decrease_shot_indicator_spd: 100
        });

        $(oMain).on("game_start", function (evt) {
            createjs.Sound.stop("soundtrack");
        });
        $(oMain).on("save_score", function (evt, iScore) {
            $.submitScore(iScore)
        });
        $(oMain).on("restart", function (evt) {
            $('#popup-wrapper').hide();
            $('.popup-content').hide()

        });
        if (isIphone()) {
            setTimeout(function () { sizeHandler(); }, 200);
        } else {
            sizeHandler();
        }
    }
  },
  // 判斷活動狀態
  accStatus: function () {
     $("#btn-play").off('click');
    let param = $.extend(userInfo, {
      'url': mis_url + "/public/ding/check",
      'actId': actId,
      'version': 0
    })
    $.loadingPost(param, function (data) {
      $("#btn-play").click(function () {
        $.accStatus()
      });

      // {
      //   ch_msg: []
      //   code: 1009
      //   code_desc: "您不在参与此活动的名单中"
      // }
      if (data.code == 200) {
        $.startGame()
      } else if (data.code == 1016) {
        $.closeMessage(data.code_desc)
        $.noScroll(false);
      } else if (data.code == 1003) {
        $.closeMessage(data.code_desc)
        $.noScroll(false);
      } else if (data.code == 1004) {
        $.closeMessage(data.code_desc)
        $.noScroll(false);
      } else if (data.code == 1014) {
        $.closeMessage(data.code_desc)
        $.noScroll(false);
      } else {
        $.closeMessage(data.code_desc)
        $.noScroll(false);
      }
    },function(err){
       // alert('cfApiEnd');
       $("#btn-play").click(function () {
         $.accStatus()
       });
       $.noScroll(false);
       // $("body").css("overflow","unset");
       // $("body").css("position","unset");
       // console.log('关闭scroll',err);

    })
  },
  // 送出遊戲分數
  submitScore(iScore) {
    let param = $.extend(userInfo, {
      'url': mis_url + "/public/ding/score",
      'actId': actId,
      'score': iScore,
      'version': 0
    })

    $.loadingPost(param, function (data) {

      if (data.code == 200) {
        // $("#myScore").hide();
        // if (parseInt(data.ch_msg[0]) > 0) {
        //   $("#goOnPlay").show()
        // } else {
        //   $("#gameArea,#startPage").hide();
        //   $.noScroll(false);
        // }
      } else if (data.code == 1016) {
        $.closeMessage(data.code_desc)
        $.noScroll(false);
      } else {
        $.closeMessage(data.code_desc)
        $.noScroll(false);
      }
    })

  },
  // 排行榜
  rankList() {
   $.noScroll(false);
    let param = $.extend(userInfo, {
      'url': mis_url + "/public/ding/leaderboard",
      'actId': actId,
      'version': 0
    })
    $.loadingPost(param, function (data) {
       // console.dir(param);
      if (data.code == 200) {
        let score = data.ch_msg[0].my; //@@空的
        $("#highestscore").html(score+'分');
        let dataList = data.ch_msg[0].result;
        //  @@
        //  ch_msg: []
        //  code: 1001
        //  code_desc: "请先登陆再操作"
        if (dataList.length == 0) {
          $("#recodeNone").show();
          $("#listRank").hide()
        } else {
          $("#recodeNone").hide();
          $("#listRank").show()
        }
        let str = "",
          arr = [];
        for (let i in dataList) {
          str += `<div>第${Number(i)+1}名 ${dataList[i].customerNo} ${dataList[i].score}分</div>`
        }
        arr.push(str)
        $("#listRank").empty().append(arr)
        $('#popup-wrapper').show();
        $('#ranking-score-section').show();

      }else if (data.code == 1001){
        // 每日只有一次游戏机会
        $.closeMessage(data.code + ":" + data.code_desc)
        // $.noScroll(false);
      }else{
        // $.noScroll(false);
      }
    })
  }
})
